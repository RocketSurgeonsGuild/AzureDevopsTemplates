parameters:
  Configuration: Release
  Verbosity: Normal
  DotNetSdk:
    - "2.2.x"
    - "3.0.x"
  NuGetVersion: "5.3.0"
  BranchNameFix: true
  Script: "cakefile.cake"
  Target: "Default"
  EnableReleaseNotes: true
  GitHub: false
  GitHubPackages: false
  GithubAuthVariableGroup: ""
  Matrix:
    Windows:
      MATRIX_NAME: "Windows"
      IMAGE_NAME: "windows-latest"
    Linux:
      MATRIX_NAME: "Linux"
      IMAGE_NAME: "ubuntu-latest"
    macOS:
      MATRIX_NAME: "macOS"
      IMAGE_NAME: "macOS-latest"
jobs:
  - job: GitVersion
    pool:
      vmImage: windows-latest
    steps:
      - template: ../gitversion/store.yml
        parameters:
          NuGetVersion: ${{ parameters.NuGetVersion }}
          BranchNameFix: ${{ parameters.BranchNameFix }}

  - template: ./cake-job.yml
    parameters:
      name: "Build"
      dependsOn:
        - GitVersion
        - ${{ if and(eq(parameters.EnableReleaseNotes, 'true'), eq(parameters.GitHub, 'true'), startsWith(variables['Build.SourceBranch'], 'refs/tags/v')) }}:
            - GitHub_Draft_Release
      Configuration: ${{ parameters.Configuration }}
      Verbosity: ${{ parameters.Verbosity }}
      DotNetSdk: ${{ parameters.DotNetSdk }}
      NuGetVersion: ${{ parameters.NuGetVersion }}
      Script: ${{ parameters.Script }}
      Target: ${{ parameters.Target }}
      EnableReleaseNotes: ${{ parameters.EnableReleaseNotes }}
      Matrix: ${{ parameters.Matrix }}

  - ${{ if and(or(startsWith(variables['Build.SourceBranch'], 'refs/tags/v'), eq(variables['Build.SourceBranch'], 'refs/heads/master')), ne(variables['System.PullRequest.IsFork'], 'true')) }}:

      - ${{ if and(eq(parameters.EnableReleaseNotes, 'true'), eq(parameters.GitHub, 'true')) }}:
          - job: GitHub_Draft_Release
            displayName: "GitHub Draft Release"
            pool:
              vmImage: "windows-latest"
            dependsOn:
              - GitVersion
            variables:
              - group: ${{ parameters.GithubAuthVariableGroup }}
            steps:
              # - checkout: none
              - template: ../gitversion/restore.yml
              - ${{ if and(eq(parameters.EnableReleaseNotes, 'true'), eq(parameters.GitHub, 'true')) }}:
                  - template: ../standard/github-draft-release.yml
                    parameters:
                      DotNetSdk: ${{ parameters.DotNetSdk }}

      - job: Publish_NuGet_Packages
        displayName: "Publish NuGet Packages"
        pool:
          vmImage: "windows-latest"
        dependsOn:
          - Build
          - ${{ if and(eq(parameters.EnableReleaseNotes, 'true'), eq(parameters.GitHub, 'true')) }}:
              - GitHub_Draft_Release
        steps:
          # - checkout: none
          - download: current
            displayName: "Download NuGet Packages"
            artifact: "Nupkg - Windows"
          - template: ../standard/nuget-push.yml
            parameters:
              Artifacts: "$(Pipeline.Workspace)/Nupkg - Windows/"
              NuGetVersion: ${{ parameters.NuGetVersion }}
              Verbosity: ${{ parameters.Verbosity }}
              GitHubPackages: ${{ parameters.GitHubPackages }}

      - ${{ if and(eq(parameters.EnableReleaseNotes, 'true'), eq(parameters.GitHub, 'true')) }}:
          - job: GitHub_Release
            displayName: "GitHub Release"
            pool:
              vmImage: "windows-latest"
            dependsOn:
              - Build
              - GitHub_Draft_Release
            variables:
              - group: ${{ parameters.GithubAuthVariableGroup }}
            steps:
              # - checkout: none
              - template: ../gitversion/restore.yml
              - template: ../standard/github-release.yml
                parameters:
                  DotNetSdk: ${{ parameters.DotNetSdk }}
