parameters:
  Configuration: Release
  Verbosity: Normal
  DotNet21Version: "2.1.801"
  DotNetVersion: "2.2.401"
  DotNet3Version: "3.0.100-preview8-013656"
  NuGetVersion: "5.2.0"
  BranchNameFix: false
  Script: 'cakefile.cake'
  Target: 'Default'
  GitHub: false
  GitHubPackages: false
jobs:
  - job: GitVersion
    pool:
      vmImage: windows-latest
    steps:
      - template: ../gitversion/store.yml
        parameters:
          NuGetVersion: ${{ parameters.NuGetVersion }}
          BranchNameFix: ${{ parameters.BranchNameFix }}

  - template: ./cake-job.yml
    parameters:
      name: 'Build'
      dependsOn: GitVersion
      Configuration: ${{ parameters.Configuration }}
      Verbosity: ${{ parameters.Verbosity }}
      DotNet21Version: ${{ parameters.DotNet21Version }}
      DotNetVersion: ${{ parameters.DotNetVersion }}
      DotNet3Version: ${{ parameters.DotNet3Version }}
      NuGetVersion: ${{ parameters.NuGetVersion }}
      Script: ${{ parameters.Script }}
      Target: ${{ parameters.Target }}

  - ${{ if ne(variables['System.PullRequest.IsFork'], 'true') }}:
    - job: GitHub_Draft_Release
      pool:
        vmImage: "windows-latest"
      dependsOn:
        - GitVersion
      steps:
        # - checkout: none
        - template: ../gitversion/restore.yml
        - ${{ if eq(parameters.GitHub, 'true') }}:
          - template: ../standard/github-draft-release.yml
            parameters:
              DotNetVersion: ${{ parameters.DotNetVersion }}
              DotNet3Version: ${{ parameters.DotNet3Version }}

    - job: Publish_NuGet_Packages
      pool:
        vmImage: "windows-latest"
      dependsOn:
        - Build
        - GitHub_Draft_Release
      steps:
        # - checkout: none
        - download: current
          displayName: "Download NuGet Packages"
          artifact: 'Nupkg - Windows'
        - template: ../standard/nuget-push.yml
          parameters:
            Artifacts: "$(Pipeline.Workspace)/Nupkg - Windows/"
            NuGetVersion: ${{ parameters.NuGetVersion }}
            Verbosity: ${{ parameters.Verbosity }}
            GitHubPackages: ${{ parameters.GitHubPackages }}

    - job: GitHub_Release
      pool:
        vmImage: "windows-latest"
      dependsOn:
        - Build
        - GitHub_Draft_Release
      steps:
        # - checkout: none
        - template: ../gitversion/restore.yml
        - ${{ if eq(parameters.GitHub, 'true') }}:
          - template: ../standard/github-release.yml
            parameters:
              DotNetVersion: ${{ parameters.DotNetVersion }}
              DotNet3Version: ${{ parameters.DotNet3Version }}

