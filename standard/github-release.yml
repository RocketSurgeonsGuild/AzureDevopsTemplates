parameters:
  DotNetVersion: "2.2.300"
  DotNet3Version: "3.0.100-preview6-012264"

steps:
  - task: UseDotNet@2
    displayName: Install dotnet ${{ parameters.DotNetVersion }}
    inputs:
      packageType: 'sdk'
      version: ${{ parameters.DotNetVersion }}

  - task: UseDotNet@2
    displayName: Install dotnet ${{ parameters.DotNet3Version }}
    inputs:
      packageType: 'sdk'
      version: ${{ parameters.DotNet3Version }}

  - task: DotNetCoreCLI@2
    displayName: 'dotnet tool install gitreleasemanager.tool'
    inputs:
      command: custom
      custom: tool
      arguments: 'install gitreleasemanager.tool'

  - pwsh: |
      $parts = '$(Build.Repository.Name)' -split '/';
      Write-Host "##vso[task.setvariable variable=GitHub.Owner]$($parts[0])"
      Write-Host "##vso[task.setvariable variable=GitHub.Repository]$($parts[1])"
    displayName: 'Assign GitHub.Owner and GitHub.Repository'

  - task: GitHubRelease@0
    displayName: 'Create GitHub Release'
    continueOnError: true
    inputs:
      gitHubConnection: github
      action: create
      title: v$(GitVersion.MajorMinorPatch)
      isDraft: true
      isPreRelease: false
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))

  - script: dotnet gitreleasemanager export -u "$(GitHub.Username)" -p "$(GitHub.Password)" -o "$(GitHub.Owner)" -r "$(GitHub.Repository)" -t "v$(GitVersion.MajorMinorPatch)" -f '$(Build.ArtifactStagingDirectory)\releasenotes\release-v$(GitVersion.MajorMinorPatch).md'
    displayName: 'Export v$(GitVersion.MajorMinorPatch) Release Notes'

  - script: dotnet gitreleasemanager export -u "$(GitHub.Username)" -p "$(GitHub.Password)" -o "$(GitHub.Owner)" -r "$(GitHub.Repository)" -f '$(Build.ArtifactStagingDirectory)\releasenotes\release.md'
    displayName: 'Export Release Notes'

  - task: PublishBuildArtifacts@1
    displayName: Publish Release Notes
    inputs:
      PathtoPublish: "$(Build.ArtifactStagingDirectory)/releasenotes/"
      ArtifactName: "Release Notes"
      ArtifactType: "Container"

  - task: GitHubRelease@0
    displayName: 'Update GitHub Release'
    inputs:
      gitHubConnection: github
      action: edit
      title: v$(GitVersion.MajorMinorPatch)
      releaseNotesFile: $(Build.ArtifactStagingDirectory)/releasenotes/release-v$(GitVersion.MajorMinorPatch).md
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))

  - script: dotnet gitreleasemanager close -u "$(GitHub.Username)" -p "$(GitHub.Password)" -o "$(GitHub.Owner)" -r "$(GitHub.Repository)" -m "v$(GitVersion.MajorMinorPatch)"
    displayName: 'Close v$(GitVersion.MajorMinorPatch) Milestone'
    condition: and(succeeded(), startsWith(variables['Build.SourceBranch'], 'refs/tags/v'))
