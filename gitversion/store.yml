#
# This task will store all gitversion variables into a json file
#   This allows subsequent jobs to include the cake information without explictly requiring gitversion to be run.
#
parameters:
  targetPath: "$(Build.ArtifactStagingDirectory)/gitversion/"
  version: "4.0.0"
  NuGetVersion: "5.1.0"

steps:
  - task: NuGetToolInstaller@1
    displayName: "Get NuGet"
    inputs:
      versionSpec: ${{ parameters.NuGetVersion }}
  - task: NuGetCommand@2
    displayName: 'NuGet custom'
    inputs:
      command: custom
      feedsToUse: config
      arguments: ${{ format('install GitVersion.CommandLine -Version "{0}" -ExcludeVersion', parameters.version) }}
  - script: GitVersion.exe /output buildserver
    displayName: Run GitVersion
    workingDirectory: GitVersion.CommandLine/tools/
  - task: RocketSurgeonsGuild.variable-tools.SerializeVariables.SerializeVariables@1
    displayName: "Serialize GitVersion Variables"
    inputs:
      filename: ${{ format('{0}/gitversion.json', parameters.targetPath) }}
      prefixes: GITVERSION
  # Should this use Pipeline Publish Artifact ??
  - task: PublishBuildArtifacts@1
    displayName: "Publish GitVersion Variables"
    inputs:
      pathtoPublish: ${{ parameters.targetPath }}
      artifactName: gitversion
