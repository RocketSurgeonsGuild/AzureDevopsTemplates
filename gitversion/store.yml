#
# This task will store all gitversion variables into a json file
#   This allows subsequent jobs to include the cake information without explictly requiring gitversion to be run.
#
parameters:
  version: "5.0.1"
  NuGetVersion: "5.3.0"
  BranchNameFix: false

steps:
  - ${{ if and(eq(parameters.BranchNameFix, 'true'), variables['System.PullRequest.SourceBranch']) }}:
    - powershell: |
        Write-Host "##vso[task.setvariable variable=Build.SourceBranch]$ENV:SYSTEM_PULLREQUEST_SOURCEBRANCH"
        $sourceBranchName = $ENV:SYSTEM_PULLREQUEST_SOURCEBRANCH -split '/' | select -last 1;
        Write-Host "##vso[task.setvariable variable=Build.SourceBranchName]$sourceBranchName"
      displayName: GitVersion Hack
  - task: gittools.gitversion.gitversion-task.GitVersion@5
    inputs:
      configFilePath: GitVersion.yml
  - task: RocketSurgeonsGuild.variable-tools.SerializeVariables.SerializeVariables@1
    displayName: "Serialize GitVersion Variables"
    inputs:
      filename: "$(Build.ArtifactStagingDirectory)/gitversion/gitversion.json"
      prefixes: GITVERSION
  - publish: "$(Build.ArtifactStagingDirectory)/gitversion/"
    displayName: "Publish GitVersion Variables"
    artifact: gitversion
